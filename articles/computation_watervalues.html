<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Watervalues computation • antaresWaterValues</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Watervalues computation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">antaresWaterValues</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/computation_watervalues.html">Watervalues computation</a></li>
    <li><a class="dropdown-item" href="../articles/grid_Matrix-parameters.html">Grid_Matrix parameters</a></li>
    <li><a class="dropdown-item" href="../articles/Reward-interpolation.html">Reward interpolation method</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/rte-antares-rpackage/antaresWaterValues/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Watervalues computation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rte-antares-rpackage/antaresWaterValues/blob/iterative_method/vignettes/computation_watervalues.Rmd" class="external-link"><code>vignettes/computation_watervalues.Rmd</code></a></small>
      <div class="d-none name"><code>computation_watervalues.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="theory">Theory<a class="anchor" aria-label="anchor" href="#theory"></a>
</h2>
<div class="section level3">
<h3 id="why-do-we-need-water-values">Why do we need water values ?<a class="anchor" aria-label="anchor" href="#why-do-we-need-water-values"></a>
</h3>
<p>Antares solves the annual unit commitment problem week by week. When
long term hydraulic storages are used in Antares, a procedure is needed
to determine which amount of water Antares should use for a given week
and which amount Antares should keep for the rest of the year. One
method to do so is to use water values.</p>
</div>
<div class="section level3">
<h3 id="what-are-water-values">What are water values ?<a class="anchor" aria-label="anchor" href="#what-are-water-values"></a>
</h3>
<p>Water values are prices in euros per MWh that helps Antares, in his
weekly sequentially resolution, to determine whether to use the water
stocked in reservoirs during the current week or to keep it for later in
the year. There is one water value per area, per week and per reservoir
level. Water value reprensents the best price at which the slice of
storage could sold between the given week and the end of the year. Water
values are comparable to marginal prices of thermal units. A simple
criterion to understand water values is the following :</p>
<ul>
<li><p>During an hour, if the marginal price is greater than the water
value, it’s better to turbine the water in the reservoir.</p></li>
<li><p>Otherwise, if the marginal price is lower than the water value
multiplied by the pumping efficiency, it’s better to pump water into the
reservoir, if pumping is possible.</p></li>
</ul>
<p>These water values are defined by the user so they need a method to
compute them.</p>
</div>
<div class="section level3">
<h3 id="how-to-compute-water-values">How to compute water values ?<a class="anchor" aria-label="anchor" href="#how-to-compute-water-values"></a>
</h3>
<p>Water values are the derivatives of Bellman values. Bellman values
are given, alike water values, for each area, each week and each
reservoir level. They represent the future avoided cost in euros when
considering the amount of water stored in the reservoir. They are
supposed to be concave with respect to the reservoir level for a given
week. In consequence, water values are supposed to be decreasing with
respect to the reservoir level for a given week and this is one strong
assumption of Antares.</p>
</div>
<div class="section level3">
<h3 id="how-to-compute-bellman-values">How to compute Bellman values ?<a class="anchor" aria-label="anchor" href="#how-to-compute-bellman-values"></a>
</h3>
<p>To compute Bellman values, dynamic programming is used by solving the
following optimization problems for each week and each reservoir level.
This means that one begins by solving the problem of the last week of
the year and then one solves the precedent week through
backtracking.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>t</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><munder><mo>max</mo><mrow><mi>U</mi><mo>∈</mo><mrow><mo stretchy="true" form="prefix">[</mo><msup><mi>U</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msup><mo>,</mo><msup><mi>U</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msup><mo stretchy="true" form="postfix">]</mo></mrow><mo>,</mo><msub><mi>X</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><msub><mi>X</mi><mi>t</mi></msub><mo>−</mo><msub><mi>U</mi><mi>t</mi></msub><mo>+</mo><msub><mi>I</mi><mi>t</mi></msub><mo>,</mo><msub><mi>X</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>∈</mo><mrow><mo stretchy="true" form="prefix">[</mo><msubsup><mi>X</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msubsup><mo>,</mo><msubsup><mi>X</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msubsup><mo stretchy="true" form="postfix">]</mo></mrow></mrow></munder><msub><mi>G</mi><mi>t</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mi>t</mi></msub><mo>,</mo><msub><mi>U</mi><mi>t</mi></msub><mo>,</mo><msub><mi>W</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>V</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
V_t(X_t) = \max_{U \in [U^{min},U^{max}],X_{t+1}=X_t-U_t+I_t,X_{t+1} \in [X_{t+1}^{min},X_{t+1}^{max}]} G_t(X_t,U_t,W_t) + V_{t+1}(X_{t+1})
</annotation></semantics></math></p>
<p>We use the following notations :</p>
<ul>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>∈</mo><mrow><mo stretchy="true" form="prefix">[</mo><mn>1</mn><mo>,</mo><mi>T</mi><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">t \in [1,T]</annotation></semantics></math>
representing the weeks of the year.</p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>t</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">V_t(X_t)</annotation></semantics></math>
is the Bellman value for week
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
and for the reservoir level at the beginning of week
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>X</mi><mi>t</mi></msub><annotation encoding="application/x-tex">X_t</annotation></semantics></math>.</p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mrow><mi>T</mi><mo>+</mo><mn>1</mn></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mrow><mi>T</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>K</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mrow><mi>T</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">V_{T+1}(X_{T+1}) = K(X_{T+1})</annotation></semantics></math>
is the Bellman value at the end of the year that is supposed to be
known.</p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>U</mi><mi>t</mi></msub><annotation encoding="application/x-tex">U_t</annotation></semantics></math>
is the amount of water generated
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">&gt;0</annotation></semantics></math>)
or pumped
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">&lt;0</annotation></semantics></math>)
with extreme values
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>U</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msup><annotation encoding="application/x-tex">U^{min}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>U</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msup><annotation encoding="application/x-tex">U^{max}</annotation></semantics></math>.
It is also called the control.</p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>I</mi><mi>t</mi></msub><annotation encoding="application/x-tex">I_t</annotation></semantics></math>
is the inflow during week
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>.</p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">[</mo><msubsup><mi>X</mi><mi>t</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msubsup><mo>,</mo><msubsup><mi>X</mi><mi>t</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msubsup><mo stretchy="true" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">[X_t^{min},X_t^{max}]</annotation></semantics></math>
are the rule curves for the beginning of week
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>.</p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mi>t</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mi>t</mi></msub><mo>,</mo><msub><mi>U</mi><mi>t</mi></msub><mo>,</mo><msub><mi>W</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">G_t(X_t,U_t,W_t)</annotation></semantics></math>
is the reward during week
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
depending on the hazards
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>W</mi><mi>t</mi></msub><annotation encoding="application/x-tex">W_t</annotation></semantics></math>
that comprise the inflow. Hazards are represented by Monte Carlo years
in Antares.</p></li>
</ul>
<p>This equation means that the reward that is possible to earn between
the beginning of week
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
and the end of the year is the best compromise between the reward at
week
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
and the reward between the beginning of week
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">t+1</annotation></semantics></math>
and the end of the year. In other words, it is the best compromise
between using water during week
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
and keeping it for the other weeks.</p>
<p><img src="images/bellman_calculation.PNG" width="528"></p>
</div>
<div class="section level3">
<h3 id="how-water-values-are-used-in-antares">How water values are used in Antares ?<a class="anchor" aria-label="anchor" href="#how-water-values-are-used-in-antares"></a>
</h3>
<p>Once water values have been computed by differentiating Bellman
values, the user should send them to Antares. Antares will use them
differently depending on the <code>hydro-princing-mode</code> :</p>
<ul>
<li><p><code>fast</code> : generating and pumping will be penalized for
the given week at the water value of the beginning of the week for the
initial level of the week similar to the explanation in <a href="#what-are-water-values">What are water values ?</a>. This mode
assumes the level of storage is not going to change during the
week.</p></li>
<li><p><code>accurate</code> (recommended) : Bellman values are built
from water values and the objective function of Antares will be to
minimize operational cost for the week minus Bellman value for the final
level of stock (that represent the avoided future costs).</p></li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="practice-how-water-values-are-computed-in-this-package">Practice : how water values are computed in this package ?<a class="anchor" aria-label="anchor" href="#practice-how-water-values-are-computed-in-this-package"></a>
</h2>
<p>There are three main steps to compute water values in this package
using Antares :</p>
<ol style="list-style-type: decimal">
<li><p>Compute rewards functions
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mi>t</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mi>t</mi></msub><mo>,</mo><msub><mi>U</mi><mi>t</mi></msub><mo>,</mo><msub><mi>W</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">G_t(X_t,U_t,W_t)</annotation></semantics></math>
for all weeks and all possible hazards.</p></li>
<li><p>Apply the precedent equation to compute Bellman values.</p></li>
<li><p>Compute the derivative of Bellman values to get water
values.</p></li>
</ol>
<p>Each step is detailed is the following paragraphs.</p>
<div class="section level3">
<h3 id="rewards-functions">Rewards functions<a class="anchor" aria-label="anchor" href="#rewards-functions"></a>
</h3>
<p>First of all, we assume that the reward
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mi>t</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mi>t</mi></msub><mo>,</mo><msub><mi>U</mi><mi>t</mi></msub><mo>,</mo><msub><mi>W</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">G_t(X_t,U_t,W_t)</annotation></semantics></math>
doesn’t depend on the reservoir level
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>X</mi><mi>t</mi></msub><annotation encoding="application/x-tex">X_t</annotation></semantics></math>
so it becomes
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mi>t</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>U</mi><mi>t</mi></msub><mo>,</mo><msub><mi>W</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">G_t(U_t,W_t)</annotation></semantics></math>
which means the reward depends only on the week, the scenario and the
control of the storage.</p>
<p>Reward functions are computed in two steps : the first one is to
launch Antares simulation (“simulation tab” in the shiny interface or
<code><a href="../reference/runWaterValuesSimulation.html">runWaterValuesSimulation()</a></code> ) and the second one is to use
the simulation results to build the reward function (“calculate water
values” tab or <code><a href="../reference/get_Reward.html">get_Reward()</a></code>).</p>
<p>For the first step, the user chooses a number of controls
(<code>nb_disc_stock</code>) for which the reward
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>G</mi><mi>t</mi></msub><annotation encoding="application/x-tex">G_t</annotation></semantics></math>
function will be evaluated. There is the same number of controls for
each week and each scenario but the value of the controls can change if
the maximum power of the turbine varies between weeks. For each control,
a complete Antares simulation is launched, IE for all weeks and all
Monte Carlo years. This means there is exactly one Antares simulation
per control. To evaluate the reward associated with a control, the
control of the storage is forced over the week by deactivating the
storage and creating two fictive nodes representing respectively
generating and pumping and a binding constraint linking the two nodes to
simulate the behavior of the storage. The reward is then the opposite of
the weekly operational cost.</p>
<p>Once all simulations are run, in the second step, simulation results
are used to build reward functions. See
<code><a href="../articles/Reward-interpolation.html">vignette("Reward-interpolation")</a></code> for more details.</p>
</div>
<div class="section level3">
<h3 id="computation-of-bellman-values">Computation of Bellman values<a class="anchor" aria-label="anchor" href="#computation-of-bellman-values"></a>
</h3>
<p>Using reward functions, one can now calculate Bellman values with
<code><a href="../reference/Grid_Matrix.html">Grid_Matrix()</a></code>. This function computes Bellman values for
each week and each scenario using the previous reward function and the
formula given in <a href="#how-to-compute-bellman-values">How to compute
Bellman values ?</a>. More details on this function are given in
<code><a href="../articles/grid_Matrix-parameters.html">vignette("grid_Matrix-parameters")</a></code></p>
</div>
<div class="section level3">
<h3 id="computation-of-water-values">Computation of water values<a class="anchor" aria-label="anchor" href="#computation-of-water-values"></a>
</h3>
<p>This last step is very simple. The package interpolates Bellman
values to have values every 1% of storage and then calculates the
derivative of Bellman values to have one value per reservoir level and
per day (water values are constant for a given week). This is done in
function <code><a href="../reference/to_Antares_Format.html">to_Antares_Format()</a></code>. Water values can be written
to Antares with <code><a href="https://rte-antares-rpackage.github.io/antaresEditObject/reference/writeWaterValues.html" class="external-link">antaresEditObject::writeWaterValues</a></code>.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Dhia Gharsallaoui, Juliette Gerbaux.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>

# antaresWaterValues

![](reference/figures/antares_simulator.png)

This package calculate water values for long term storages in Antares
studies. It uses Antares simulations and dynamic programming.

More theoretical details are given in :
[`vignette("computation_watervalues")`](https://rte-antares-rpackage.github.io/antaresWaterValues/articles/computation_watervalues.md).

## Installation

You can install the latest version of antaresWaterValues from GitHub
with:

``` r
# install.packages("devtools")
devtools::install_github("rte-antares-rpackage/antaresWaterValues@*release") 
```

To load the package use :

``` r
library(antaresWaterValues)
```

Now we are ready to use our package. If something gets wrong, please
check dependencies versions in `DESCRIPTION`.

The package edits the Antares study and resets it at the end but it
could be wise to make a copy of the study before using the package for
the first time.

## Using the Shiny app

``` r
opts = antaresRead::setSimulationPath("your/path/to/the/antares/study","input") 
shiny_water_values(opts)
```

## Without the Shiny app

Begin by defining some parameters about your study.

``` r
opts <- antaresRead::setSimulationPath("your/path/to/the/antares/study","input")
```

``` r
area <- "area"
pumping <- T #T if pumping possible
mcyears <- 1:3 # Monte Carlo years you want to use
efficiency <- getPumpEfficiency(area,opts=opts)
name = "3sim"
```

Then, you have to run simulations.

``` r
simulation_res <- runWaterValuesSimulation(
    area=area,
    nb_disc_stock = 3, #number of simulations
    mcyears = mcyears,
    path_solver = "your/path/to/antares/bin/antares-8.6-solver.exe",
    opts = opts,
    file_name=name, #name of the saving file
    pumping=pumping,
    efficiency=efficiency
  )
```

If you want to retrieve results from previous simulations, you can use :

``` r
load(paste0(opts$studyPath, "/user/", tolower(area),"_",name, ".RData"))
```

Now compute reward functions :

``` r
reward_db <- get_Reward(
  simulation_names = simulation_res$simulation_names,
  simulation_values = simulation_res$simulation_values,
  opts=opts,
  area = area,
  mcyears = mcyears,
  efficiency = efficiency,
  method_old = T,# T if you want a simple linear interpolation of rewards,
                 # F if you want to use marginal price to interpolate
  possible_controls = constraint_generator(area=area,
                                           nb_disc_stock = 20,
                                           mcyears=mcyears,
                                           pumping = pumping,
                                           efficiency = efficiency,
                                           opts=opts)# used for marginal prices interpolation
)
reward <- reward_db$reward
```

Finally, compute water values :

``` r
results <- Grid_Matrix(
  area=area,
  reward_db = reward_db,
  mcyears = mcyears,
  states_step_ratio = 1/20, # discretization of states
  opts = opts,
  efficiency=efficiency,
  penalty_low = 1000,#penalty for bottom rule curve
  penalty_high = 100,#penalty for top rule curve
  force_final_level = T, # T if you want to constrain final level with penalties (see Grid_Matrix documentation for more information)
  final_level = get_initial_level(area=area,opts=opts), # wanted final level (between 0 and 100%)
  penalty_final_level_low = 2000,
  penalty_final_level_high = 2000
)
```

![](reference/figures/README-grid_matrix-1.png)

``` r
aggregated_results <- results$aggregated_results
```

Water values are written to Antares thanks to the following instructions
:

``` r
reshaped_values <- aggregated_results %>%
  to_Antares_Format_bis()
antaresEditObject::writeWaterValues(
  area = area,
  data = reshaped_values
)
```

Values in `reshaped_values` are not monotone because Antares will
average values.

Before running a simulation, `hydro-princing-mode` must be change to
`accurate` :

``` r
settings_ini <- antaresRead::readIni(file.path("settings", "generaldata.ini"),opts=opts)
settings_ini$`other preferences`$`hydro-pricing-mode` = "accurate"
antaresEditObject::writeIni(settings_ini, file.path("settings", "generaldata.ini"),overwrite=T,opts=opts)
```

### Plot results

``` r
waterValuesViz(Data=aggregated_results,filter_penalties = T)
```

![](reference/figures/README-watervalues-1.png)

``` r
plot_Bellman(value_nodes_dt = aggregated_results, 
             weeks_to_plot = c(1,3))
```

![](reference/figures/README-bellman-1.png)

You can also plot reward functions

``` r
plot_1 <- plot_reward(reward_base = reward,
                      weeks_to_plot = c(1,3))
```

![](reference/figures/README-reward-1.png)

``` r
plot_2 <- plot_reward_mc(reward_base = reward,
                         weeks_to_plot = c(1,3),
                         scenarios_to_plot = c(1,2))
```

![](reference/figures/README-reward-2.png)

``` r
plot_3 <- plot_reward_variation(reward_base = reward,
                                weeks_to_plot = c(1,3))
```

![](reference/figures/README-reward-3.png)

``` r
plot_4 <- plot_reward_variation_mc(reward_base = reward,
                                   weeks_to_plot = c(1,3),
                                   scenarios_to_plot = c(1,2))
```

![](reference/figures/README-reward-4.png)

## Multi stock

To compute Bellman values for multiple storages, you can use
[`getBellmanValuesFromOneSimulationMultistock()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/getBellmanValuesFromOneSimulationMultistock.md)
or you can compute Bellman values storage per storage. In all cases, be
sure to use the hydro heuristic of Antares for all storages when
computing Bellman values.

# Package index

## All functions

- [`Grid_Matrix()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/Grid_Matrix.md)
  : Compute Bellman values

- [`MultiStock_H2_Investment_reward_compute_once()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/MultiStock_H2_Investment_reward_compute_once.md)
  : Compute optimal candidates for H2 system

- [`calculateBellmanWithIterativeSimulations()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/calculateBellmanWithIterativeSimulations.md)
  : Calculate Bellman values throughout iterations of Antares simulation
  and DP Each simulation leads to a new reward estimation, which leads
  to new water values, which leads to the off-line calculation in R of
  an optimal trajectory, which leads to new controls to be evaluated
  which leads to a new simulation

- [`calculateBellmanWithIterativeSimulationsMultiStock()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/calculateBellmanWithIterativeSimulationsMultiStock.md)
  : Calculate Bellman values throughout iterations of Antares simulation
  and DP Each simulation leads to a new reward estimation, which leads
  to new water values, which leads to the off-line calculation in R of
  an optimal trajectory, which leads to new controls to be evaluated
  which leads to a new simulation

- [`calculateRewardsSimulations()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/calculateRewardsSimulations.md)
  :

  Compute reward function with the 5 simulations method. Called for each
  area of `MultiStock_H2_Investment_reward_compute_once`. If they are
  several areas, the trajectories of the other storage are fixed on
  their optimal trend.

- [`changeHydroManagement()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/changeHydroManagement.md)
  : Change hydro management

- [`constraint_generator()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/constraint_generator.md)
  : Generate control values

- [`getBellmanValuesFromOneSimulationMultistock()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/getBellmanValuesFromOneSimulationMultistock.md)
  : Compute Bellman values for several storage based on one simulation

- [`getOptimalTrend()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/getOptimalTrend.md)
  :

  Calculate an optimal trajectory for the reservoir levels based on
  water values taking into account the mean inflow, used in
  `calculateBellmanWithIterativeSimulations`

- [`getPumpEfficiency()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/getPumpEfficiency.md)
  : Get pumping efficiency ratio

- [`get_Reward()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/get_Reward.md)
  : Compute reward functions

- [`get_inflow()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/get_inflow.md)
  : Get weekly inflows

- [`get_initial_level()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/get_initial_level.md)
  : Get initial level

- [`get_initial_level_year_per_year()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/get_initial_level_year_per_year.md)
  : Get initial level year per year

- [`get_local_reward()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/get_local_reward.md)
  : Compute reward functions based on one given simulation

- [`get_max_hydro()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/get_max_hydro.md)
  : Get pumping and generating hydro power

- [`get_reservoir_capacity()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/get_reservoir_capacity.md)
  : Get reservoir capacity

- [`get_weekly_cost()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/get_weekly_cost.md)
  :

  Get objective values of the optimization problem of each week and each
  scenario for a given simulation `simu`, mainly used in
  [`get_Reward()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/get_Reward.md)
  to build reward functions.

- [`grid_other_candidates()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/grid_other_candidates.md)
  : Compute the list of cluster candidates to study following their
  bounds

- [`max_candidate()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/max_candidate.md)
  : Compute the candidate with maximal reward

- [`new_bounds()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/new_bounds.md)
  : Updates the candidates bounds at the end of an iteration.

- [`plot_Bellman()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/plot_Bellman.md)
  : Plot Bellman and water values

- [`plot_reward()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/plot_reward.md)
  : Plot mean reward

- [`plot_reward_mc()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/plot_reward_mc.md)
  : Plot reward

- [`plot_reward_variation()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/plot_reward_variation.md)
  : Plot mean reward variation

- [`plot_reward_variation_mc()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/plot_reward_variation_mc.md)
  : Plot reward variation

- [`readReservoirLevels()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/readReservoirLevels.md)
  : Read reservoir rule curves

- [`remove_out()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/remove_out.md)
  : Post process water values

- [`reward_offset()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/reward_offset.md)
  : Take into account overall cost in local reward

- [`runWaterValuesSimulation()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/runWaterValuesSimulation.md)
  : Run Antares simulations in order to compute water values for a
  specific area

- [`runWaterValuesSimulationMultiStock()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/runWaterValuesSimulationMultiStock.md)
  : Run Antares simulations in order to compute water values for
  multiple areas

- [`shiny_water_values()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/shiny_water_values.md)
  : Open web interface for computing water values

- [`to_Antares_Format()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/to_Antares_Format.md)
  : Convert water values to Antares format

- [`to_Antares_Format_bis()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/to_Antares_Format_bis.md)
  : Convert water values to Antares format with high accuracy

- [`total_cost_loop()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/total_cost_loop.md)
  : Computes the total reward for a specific candidate following the
  reward function

- [`total_cost_parallel_version()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/total_cost_parallel_version.md)
  :

  Computes the total reward for a list of candidate following the reward
  function, with parallel processing. The storage volume is constant.
  These function is called inside `parLapply()`.

- [`updateReward()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/updateReward.md)
  :

  Update df_rewards with latest simulation run, used in
  `calculateBellmanWithIterativeSimulations`

- [`updateWatervalues()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/updateWatervalues.md)
  :

  Calculate water values with `Grid_Matrix` from estimated reward, used
  in `calculateBellmanWithIterativeSimulations`

- [`update_reward_cluster_bande()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/update_reward_cluster_bande.md)
  : Modify the reward function to take into account the effects of a
  must-run cluster.

- [`update_reward_cluster_flexible()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/update_reward_cluster_flexible.md)
  : Modify the reward function to take into account the effects of a non
  must-run cluster, with a speciifc capcaity and marginal cost.

- [`waterValuesViz()`](https://rte-antares-rpackage.github.io/antaresWaterValues/reference/waterValuesViz.md)
  : Plot water values

# Articles

### All vignettes

- [Watervalues
  computation](https://rte-antares-rpackage.github.io/antaresWaterValues/articles/computation_watervalues.md):
- [Grid_Matrix
  parameters](https://rte-antares-rpackage.github.io/antaresWaterValues/articles/grid_Matrix-parameters.md):
- [Reward interpolation
  method](https://rte-antares-rpackage.github.io/antaresWaterValues/articles/Reward-interpolation.md):
